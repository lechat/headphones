<%inherit file="base.html" />
<%!
	import headphones
	import time
	from headphones import progress,databases
	from headphones.helpers import checked
%>
<%def name="headerIncludes()">
	<div id="subhead_container">
		<div id="subhead_menu">
			<a class="menu_link_edit" id="manage_albums" href="#">Manage Albums</a>
				<div id="dialog" title="Choose Album Filter" style="display:none" class="configtable">
					<div class="links">
						<a href="manageAlbums?Status=Downloaded"><span class="ui-icon ui-icon-check"></span>Manage Downloaded Albums</a><br>
						<a href="manageAlbums?Status=Skipped"><span class="ui-icon ui-icon-flag"></span>Manage Skipped Albums</a><br>
						<a href="manageAlbums?Status=Snatched"><span class="ui-icon ui-icon-arrowthickstop-1-s"></span>Manage Snatched Albums</a><br>
						<a href="manageAlbums?Status=Upcoming"><span class="ui-icon ui-icon-calendar"></span>Manage Upcoming Albums</a><br>
						<a href="manageAlbums?Status=Wanted"><span class="ui-icon ui-icon-heart"></span>Manage Wanted Albums</a><br>
						<br><br>
						<a href="manageAlbums">Manage All Albums</a>
					</div>
				</div>
			<a class="menu_link_edit" href="manageArtists">Manage Artists</a>
			%if not headphones.ADD_ARTISTS:
			<a class="menu_link_edit" href="manageNew">Manage New Artists</a>
			%endif
		</div>
	</div>	
</%def>

<%def name="body()">
	<div id="paddingheader">
		<h1 class="clearfix"><img src="interfaces/default/images/icon_manage.png" alt="manage"/>Manage</h1>
	</div>
	<div id="tabs">
		<ul>
			<li><a href="#tabs-1">Scan Music Library</a></li>
			<li><a href="#tabs-5">Artists Statistics</a></li>
			<li><a href="#tabs-2">Imports</a></li>
			<li><a href="#tabs-3">Force Actions</a></li>
			<li><a href="#tabs-4">Show Progress</a></li>
		</ul>
		
		<div id="tabs-5" class="configtable">
			<legend>Artist statistics:</legend>
			<%
				now = time.localtime(time.time())
				p5 = str(now.tm_year - 5) + "-" + str(now.tm_mon) + "-" + str(now.tm_mday)
				p10 = str(now.tm_year - 10) + "-" + str(now.tm_mon) + "-" + str(now.tm_mday)
				
				myDB = databases.getDBConnection()
				stats = myDB.selectOne("SELECT SUM(CASE WHEN (releasedate is NULL or releasedate = '') and Status = 'Active' THEN 1 ELSE 0 END) as oldNone, \
						                       SUM(CASE WHEN (releasedate is NULL or releasedate = '') and Status != 'Active' THEN 1 ELSE 0 END) as oldNoneP, \
									           SUM(CASE WHEN releasedate < '" + p10 + "' and Status = 'Active' THEN 1 ELSE 0 END) AS old10, \
									           SUM(CASE WHEN releasedate < '" + p10 + "' and Status != 'Active' THEN 1 ELSE 0 END) AS old10P, \
									           SUM(CASE WHEN releasedate < '" + p5 + "' and Status = 'Active' THEN 1 ELSE 0 END) AS old5, \
									           SUM(CASE WHEN releasedate < '" + p5 + "' and Status != 'Active' THEN 1 ELSE 0 END) AS old5P, \
									           COUNT(*) as oldAll \
									           FROM artists")
			%>
			<table>
				<thead>
					<th width="40%"></th><th width="25%">Active Artists</th><th width="25%">Paused Artists</th><th width="10%">Commands</th>
				</thead>
				<tr>
					<td>No last album:</td><td>${stats['oldNone']}</td><td>${stats['oldNoneP']}</td>
					<td>
						<a href="#" onclick="doAjaxCall('autoManage?atype=None&effect=pause',$(this),'tabs');return false;" data-success="Artists paused"><span class="ui-icon ui-icon-pause"></span></a>
						<a href="#" onclick="doAjaxCall('autoManage?atype=None&effect=resume',$(this),'tabs');return false;" data-success="Artists resumed"><span class="ui-icon ui-icon-play"></span></a>
					</td>
				<tr>
					<td>Last album before ${p10}</td><td>${stats['old10']}</td><td>${stats['old10P']}</td>
					<td>
						<a href="#" onclick="doAjaxCall('autoManage?atype=y10&effect=pause',$(this),'tabs');return false;" data-success="Artists paused"><span class="ui-icon ui-icon-pause"></span></a>
						<a href="#" onclick="doAjaxCall('autoManage?atype=y10&effect=resume',$(this),'tabs');return false;" data-success="Artists resumed"><span class="ui-icon ui-icon-play"></span></a>
					</td>
				</tr>
				<tr>
					<td>Last album before ${p5}</td><td>${stats['old5']}</td><td>${stats['old5P']}</td>
					<td>
						<a href="#" onclick="doAjaxCall('autoManage?atype=y5&effect=pause',$(this),'tabs');return false;" data-success="Artists paused"><span class="ui-icon ui-icon-pause"></span></a>
						<a href="#" onclick="doAjaxCall('autoManage?atype=y5&effect=resume',$(this),'tabs');return false;" data-success="Artists resumed"><span class="ui-icon ui-icon-play"></span></a>
					</td>
				</tr>
				<tr>
					<td>Total</td><td>${stats['oldAll']}</td><td></td>
					<td>
						<a href="#" onclick="doAjaxCall('autoManage?atype=All&effect=pause',$(this),'tabs');return false;" data-success="Artists paused"><span class="ui-icon ui-icon-pause"></span></a>
						<a href="#" onclick="doAjaxCall('autoManage?atype=All&effect=resume',$(this),'tabs');return false;" data-success="Artists resumed"><span class="ui-icon ui-icon-play"></span></a>
					</td>
				</tr>
			</table>
		</div>		
		
		<div id="tabs-4" class="configtable">
			<legend>Currently active processes:</legend>
			<div class="row">
			<%
				progress.check()
				progress.lock()
			%>
			<table>
			<thead>
				<th>Name</th><th>Count</th><th>Elapsed Time</th><th>Perc. Complete</th><th>Estimated Time</th>
			</thead>
			</thead>
			%for p in progress.progressData:
				%if p.name <> None:
					<%
						x=1
						stats=p.stats()
					%>
					<tr>
						<td><div>${p.name} (${p.threadID})</div><small>${p.description}</small></td>
						<td><span title="${stats['pct']}"><span><div class="progress-container"><div style="width:${stats['pct']}%"><div class="havetracks">${stats['cnt']}</div></div></div></td>
						<td>${stats['elapsed']}</td>
						<td>${stats['pct']}</td>
						<td>${stats['estimate']}</td>
					</tr>
				%endif
			%endfor
			</table>
			<%
				progress.unlock()
			%>
			</div>
		</div>
		<div id="tabs-1" class="configtable">
			<fieldset>
				<form action="musicScan" method="GET" id="musicScan">
					<legend>Scan Music Library</legend>
					<p><strong>Where do you keep your music?</strong></p>
					<p>You can put in any directory, and it will scan for audio files in that folder
					(including all subdirectories). <br/><small>For example: '/Users/name/Music'</small></p>	
					<p>
					It may take a while depending on how many files you have. You can navigate away from the page<br />
					as soon as you click 'Save changes'
					</p>	
					<br/>
					<div class="row">
								<label for="">Path to directory</label>
					%if headphones.MUSIC_DIR:
						<input type="text" value="${headphones.MUSIC_DIR}" name="path" size="70" />
					%else:
						<input type="text" value="Enter a Music Directory to scan" onfocus="if
						(this.value==this.defaultValue) this.value='';" name="path" size="70" />
					%endif
					</div>
					<div class="row checkbox"> 
					<input type="checkbox" name="libraryscan" id="libraryscan" value="1" ${checked(headphones.LIBRARYSCAN)}><label>Automatically scan library</label>
					</div>
					<div class="row checkbox"> 
					<input type="checkbox" name="autoadd" id="autoadd" value="1" ${checked(headphones.ADD_ARTISTS)}><label>Auto-add new artists</label>
					</div>
								
				</fieldset>
				<br>
				<input type="button" value="Save Changes and Scan" onclick="addScanAction();doAjaxCall('musicScan',$(this),'tabs',true);return false;" data-success="Changes saved. Library will be scanned">
				<input type="button" value="Save Changes without Scanning Library" onclick="doAjaxCall('musicScan',$(this),'tabs',true);return false;" data-success="Changes Saved Successfully">
			</form>
		</div>

	<div id="tabs-2" class="configtable">
		<form action="importLastFM" method="GET" id="importLastFM">
			<fieldset>
			<legend>Import Last.FM Artists</legend>
			<p>Enter the username whose artists you want to import:</p>		
			<br/>
			<div class="row">
				<label for="">Username</label>
				<%
					if headphones.LASTFM_USERNAME:
						lastfmvalue = headphones.LASTFM_USERNAME
					else:
						lastfmvalue = ''
				%>
				<input type="text" value="${lastfmvalue}" placeholder="Last.fm username" onfocus="if
				(this.value==this.defaultValue) this.value='';" name="username" id="username" size="18" />
				<a href="#" onclick="doAjaxCall('importLastFM?username=',$(this),'tabs');return false;" data-success="Last.fm username has been reset"><span class="ui-icon ui-icon-arrowreturnthick-1-w"></span>Reset username</a>
			</div>
			</fieldset>
			<input type="button" value="Save changes" onclick="doAjaxCall('importLastFM',$(this),'tabs',true);return false;" data-success="Last.fm artists will be imported" data-error="Fill in a last.fm username"/>
		</form>
        <br/>
        <form action="importLastFMTag" method="GET" id="importLastFMTag">
            <fieldset>
            <legend>Import Last.FM Tag</legend>
            <p>Enter tag from which you want import top artists:</p>
            <br/>
            <div class="row">
                <label>Tag</label>
			    <input type="text" value="" onfocus="if
                (this.value==this.defaultValue) this.value='';" name="tag" id="tag" size="18" />
                <br/>
                <label>Limit</label>
			    <input type="text" value="50" onfocus="if
			    (this.value==this.defaultValue) this.value='';" name="limit" id="limit" size="18" />
            </div>
            </fieldset>
            <input type="submit" />
        </form>
    </div>


	
	<div id="tabs-3" class="configtable">
		<fieldset>
			<legend>Force Search</legend>
			<div class="links">
				<a href="#" onclick="doAjaxCall('forceSearch',$(this))" data-success="Checking for wanted albums successful" data-error="Error checking wanted albums"><span class="ui-icon ui-icon-search"></span>Force Check for Wanted Albums</a>
				<a href="#" onclick="doAjaxCall('forceUpdate',$(this))" data-success="Update active artists successful" data-error="Error forcing update artists"><span class="ui-icon ui-icon-heart"></span>Force Update Active Artists</a>
				<a href="#" onclick="doAjaxCall('forcePostProcess',$(this))" data-success="Post-Processor is being loaded" data-error="Error during Post-Processing"><span class="ui-icon ui-icon-wrench"></span>Force Post-Process Albums in Download Folder</a>
				<a href="#" onclick="doAjaxCall('checkDB',$(this))" data-success="Checking Database..." data-error="Error starting DB check"><span class="ui-icon ui-icon-gear"></span>Check database</a>
				<a href="#" onclick="doAjaxCall('checkGithub',$(this))" data-success="Checking for update successful" data-error="Error checking for update"><span class="ui-icon ui-icon-refresh"></span>Check for Headphones Updates</a>
				<a href="#" id="delete_empty_artists"><span class="ui-icon ui-icon-trash"></span>Delete empty Artists</a>
					<div id="emptyartistdialog" title="Confirm Artist Deletion" style="display:none" class="configtable">
					    %if emptyArtists:
						<h3>The following artists will be deleted:</h3>
						
						%for emptyArtist in emptyArtists:
							<p>${emptyArtist['ArtistName']}</p>
						%endfor
						<input type="button" value="Delete Empty Artists" onclick="doAjaxCall('deleteEmptyArtists',$(this))" data-success="Empty Artists deleted" data-error="Error deleting empty artists">
					    %else:
					        No empty artists found.
					    %endif
					</div>
			</div>
		</fieldset>
		
	</div>
</div>
</%def>
<%def name="javascriptIncludes()">
	<script>
		function addScanAction() {
			$('#autoadd').append('<input type="hidden" name="scan" value=1 />');
		};
		
		function initThisPage() {
			$('#manage_albums').click(function() {
				$('#dialog').dialog();
				return false;
			});
			$('#delete_empty_artists').click(function() {
				$('#emptyartistdialog').dialog();
				return false;
			});
			jQuery( "#tabs" ).tabs();
			initActions();
		};
		$(document).ready(function() {
			initThisPage();
		});
	</script>
</%def>
